name: Deploy to AWS EC2

on:
  push:
    branches:
      - main

permissions:
  contents: read

env:
  TF_BACKEND_BUCKET: ${{ secrets.TF_BACKEND_BUCKET }}
  TF_BACKEND_KEY: frontend/terraform.tfstate
  TF_BACKEND_REGION: ${{ secrets.AWS_REGION }}
  TF_BACKEND_DDB_TABLE: ${{ secrets.TF_BACKEND_DDB_TABLE }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ secrets.DOCKERHUB_USERNAME }}/frontend-app
          tags: |
            type=sha,prefix=main-
            type=raw,value=latest

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

  deploy-infrastructure:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Get API Gateway URL from Shared Infrastructure
        id: get_api_url
        run: |
          # Obtener el output de la infraestructura compartida desde el state de Terraform
          aws s3 cp s3://$TF_BACKEND_BUCKET/shared/terraform.tfstate - | \
            jq -r '.outputs.api_gateway_invoke_url.value' > /tmp/api_url.txt
          
          API_GATEWAY_URL=$(cat /tmp/api_url.txt)
          
          if [ -z "$API_GATEWAY_URL" ] || [ "$API_GATEWAY_URL" = "null" ]; then
            echo "Error: No se pudo obtener la URL del API Gateway"
            exit 1
          fi
          
          echo "API Gateway URL: $API_GATEWAY_URL"
          echo "api_gateway_url=$API_GATEWAY_URL" >> $GITHUB_OUTPUT

      - name: Update AWS Secrets Manager
        run: |
          API_GATEWAY_URL="${{ steps.get_api_url.outputs.api_gateway_url }}"
          
          aws secretsmanager put-secret-value \
            --secret-id frontend-app-secrets \
            --secret-string "$(jq -n \
              --arg auth_url "${API_GATEWAY_URL}/auth" \
              --arg docs_url "${API_GATEWAY_URL}/docs" \
              --arg jwt "${{ secrets.JWT_SECRET }}" \
              --arg env "${{ secrets.NODE_ENV }}" \
              --arg docker_user "${{ secrets.DOCKERHUB_USERNAME }}" \
              '{
                AUTH_BASE_URL: $auth_url,
                DOCUMENTS_BASE_URL: $docs_url,
                JWT_SECRET: $jwt,
                NODE_ENV: $env,
                DOCKERHUB_USERNAME: $docker_user
              }')" || true

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3

      - name: Terraform Init
        working-directory: infra/terraform
        run: |
          terraform init -input=false -upgrade \
            -backend-config="bucket=$TF_BACKEND_BUCKET" \
            -backend-config="key=$TF_BACKEND_KEY" \
            -backend-config="region=$TF_BACKEND_REGION" \
            -backend-config="dynamodb_table=$TF_BACKEND_DDB_TABLE" \
            -backend-config="encrypt=true"

      - name: Terraform Validate
        working-directory: infra/terraform
        run: terraform validate

      - name: Terraform Apply
        working-directory: infra/terraform
        run: |
          terraform apply -auto-approve -input=false \
            -var="dockerhub_username=${{ secrets.DOCKERHUB_USERNAME }}"

      - name: Display Application URL
        working-directory: infra/terraform
        run: |
          echo "Application URL: http://$(terraform output -raw instance_public_ip)"
